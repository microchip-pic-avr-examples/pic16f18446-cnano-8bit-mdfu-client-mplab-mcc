[![MCHP](../images/microchip.png)](https://www.microchip.com)

# 8-Bit MDFU Client Setup for I<sup>2</sup>C Communication

[Go Back](../README.md)

## Required Hardware
- [Curiosity Nano Base for Click boardsâ„¢](https://www.microchip.com/en-us/development-tool/AC164162)
- [MCP2221A Breakout Module](https://www.microchip.com/en-us/development-tool/ADM00559)
-  Three female-to-male jumper wires

## Hardware Configuration
[![MDFU_I2C_HW](../images/i2c/HardwareSetup_I2C.png)](../images/i2c/HardwareSetup_I2C.png)

## 8-Bit MDFU Client I<sup>2</sup>C Communication

- Communication Protocol: I2C
- Application Start Address: 0x2000
- Device ID: 0x30D4 (automatically added)
- I/O Pin Indicator: Enabled
- I/O Pin Entry: Enabled
- Memory Verification: CRC32

[![MDFU](../images/i2c/MDFUClientSetup.png)](../images/i2c/MDFUClientSetup.png)

**I2C**
- Custom Name: SERCOM
- Client Address: 0x20
- Client Mask: 0x7F
- I2C Client PLIB Selector: MSSP2

[![I2C](../images/i2c/I2CDriverSetup.png)](../images/i2c/I2CDriverSetup.png)

**MSSP2 PLIB**
- Serial Protocol: I2C
- Interrupt Driven: Enabled

[![I2C_PLIB](../images/i2c/I2CPLIBSetup.png)](../images/i2c/I2CPLIBSetup.png)

**I2C Pins**
- MSSP SCL: RB7
- MSSP SDA: RB5

[![I2C_Pins](../images/i2c/I2CPortsSetup.png)](../images/i2c/I2CPortsSetup.png)

**8-Bit MDFU Client I/O**
- BOOT INDICATE: RA2
- BOOT ENTRY: RC2

[![IO-Pins](../images/i2c/IOPortSetup.png)](../images/i2c/IOPortSetup.png)

- BOOT INDICATE: Start High
- BOOT ENTRY: Weak Pull-up

[![IO-Settings](../images/IOPinsSetup.PNG)](../images/IOPinsSetup.PNG)

**8-Bit MDFU Client Project Properties**
- ROM Ranges: This option is configured based on the application's start address. For example, if the application starts at 0x2000 then this value will reflect as 00-7FF,800-FFF,1000-17FF,1800-1FFF.

[![IO-Settings](../images/i2c/ProjectProperties.png)](../images/i2c/ProjectProperties.png)

### Application Setup
Refer to the [Application Setup](../README.md#application-setup) section in the main Readme file.

## Operation
This example shows how to execute the CRC32 verification example and update the device Flash memory with the CRC32 application image to demonstrate a successful device firmware update (DFU) over the I<sup>2</sup>C communication protocol.

**8-Bit MDFU Client Operation**

1. Open the MDFU client project.

[![OpenMDFU](../images/openBtnMDFU.png)](../images/openBtnMDFU.png)

[![OpenMDFUProject](../images/i2c/openProjectMDFU.png)](../images/i2c/openProjectMDFU.png)

2. Set MDFU client project as Main Project.

[![SetAsMainMDFUProject](../images/setAsMainProject_SPI.PNG)](../images/setAsMainProject_SPI.PNG)

3. Right click, then select Clean and Build.

[![CleanBuild](../images/i2c/CleanAndBuildMDFU.png)](../images/i2c/CleanAndBuildMDFU.png)

4. Program the MDFU client project.

[![ProgramMDFU](../images/i2c/ProgramMDFU.png)](../images/i2c/ProgramMDFU.png)

**Bootloader Operation after initial programming**

After initial programming, the LED must be on.

[![MDFU_BootMode](../images/i2c/PIC16F18446_BootMode.png)](../images/i2c/PIC16F18446_BootMode.png)

**Application Operation**
1. Open the application project configured for the selected verification scheme.

[![OpenApp](../images/openBtnApp_SPI.PNG)](../images/openBtnApp_SPI.PNG)

[![OpenAppProject](../images/i2c/openProjectApp.png)](../images/i2c/openProjectApp.png)

2. Set the application project as the Main Project.

[![MainAppProject](../images/setAppAsMainProject_SPI.PNG)](../images/setAppAsMainProject_SPI.PNG)

3. Build the application project.

Right click, then select Clean and Build.

[![CleanBuild_App](../images/i2c/CleanAndBuildApp.png)](../images/i2c/CleanAndBuildApp.png)

4. Build the Application Image File using [pyfwimagebuilder](https://pypi.org/project/pyfwimagebuilder/).

- Navigate to the Project tab and right click on *Important Files>`build_free_image.bat`* for Windows or *Important Files>`build_free_image.sh`* for Mac and Linux.
- Select Run.

[![Run_BuildScript](../images/RunBuildScript_SPI.PNG)](../images/RunBuildScript_SPI.PNG)

**Example Command:**

Below is an example of the command used in the above step.

`pyfwimagebuilder build -i "application_hex_file.hex"  -c "mdfu_config_file.toml" -o output.img`

[![build_img](../images/i2c/BuildTheImage.png)](../images/i2c/BuildTheImage.png)

> **Tip**: The configuration TOML file is generated by the MDFU Client project.

[![FindTheTOML_BL](../images/ConfigPathExample_SPI.PNG)](../images/ConfigPathExample_SPI.PNG)

5. Use the [pymdfu](https://pypi.org/project/pymdfu/) Host tool to transfer the application image file to the bootloader.

- Navigate to the project tab and right click, *Important Files>`pymdfu_update.bat`* for Windows or *Important Files>`pymdfu_update.sh`* for Mac and Linux. Double click to open the file.
- Then right click on the script in the Files tab and select Run.

[![UpdateScript_BL](../images/runUpdateScript_SPI.PNG)](../images/runUpdateScript_SPI.PNG)

**Example Command:**

Below is an example of the command used in the above step.

`pymdfu update --tool mcp2221a --image ./output.img --interface i2c --address 32 --clk-speed 100k`

[![transfer_img](../images/i2c/SendTheImage.png)](../images/i2c/SendTheImage.png)

**Application Has Been Updated Successfully**

[![MDFU_AppMode](../images/i2c/PIC16F18446_AppMode.gif)](../images/i2c/PIC16F18446_AppMode.gif)

[Back to top](#8-bit-mdfu-client-setup-for-i2c-communication)
